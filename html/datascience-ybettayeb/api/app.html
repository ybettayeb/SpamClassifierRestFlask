<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>datascience-ybettayeb.api.app API documentation</title>
<meta name="description" content="Created on Fri Mar 26 19:24:00 2021 â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>datascience-ybettayeb.api.app</code></h1>
</header>
<section id="section-intro">
<p>Created on Fri Mar 26 19:24:00 2021</p>
<p>@author: ybettayeb</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
&#34;&#34;&#34;
Created on Fri Mar 26 19:24:00 2021

@author: ybettayeb
&#34;&#34;&#34;
# never used flask so i&#39;ll most likely copy a get started tutorial about it
import flask
from flask import Flask, render_template, url_for, request
from flask import request, jsonify
import pandas as pd
import pickle
import sqlite3 
from datetime import datetime
from sklearn.feature_extraction.text import CountVectorizer
app = Flask(__name__)
app.config[&#34;DEBUG&#34;] = True




def dict_factory(cursor, row): 
    &#34;&#34;&#34;
    wrapper function to turn sqlite rows into dictionnary, to help us jsonify them

    Args:
        cursor (sqliteCursor): connection cursor
        row (cursor.row): sqlQuery Row

    Returns:
        dictionary: dictionnary containing the result of the query
    &#34;&#34;&#34;
    d = {}
    for idx, col in enumerate(cursor.description):
        d[col[0]] = row[idx]
    return d

@app.route(&#39;/&#39;, methods=[&#39;GET&#39;])
def home():
    &#34;&#34;&#34;
    basic home page rendering, not much to see there
    &#34;&#34;&#34;
    return &#39;&#39;&#39;&lt;h1&gt;Spam Classifier&lt;/h1&gt; &lt;p&gt;prototype API to detect if you&#39;re spamming or hamming &lt;/p&gt;&#39;&#39;&#39;

@app.errorhandler(404)
def page_not_found(e):
    &#34;&#34;&#34;
    handling of 404 error
    &#34;&#34;&#34;
    return &#34;&lt;h1&gt;404&lt;/h1&gt;&lt;p&gt;The resource could not be found.&lt;/p&gt;&#34;, 404

@app.route(&#39;/api/v1/resources/predictions/all&#39;, methods=[&#39;GET&#39;])
def api_all():
    &#34;&#34;&#34;
    this function will return the entire prediction database when queried

    Returns:
        json: query result as a json
    &#34;&#34;&#34;
    conn = sqlite3.connect(&#39;database.db&#39;)
    conn.row_factory = dict_factory
    cur = conn.cursor()
    all_logs = cur.execute(&#39;&#39;&#39;SELECT * FROM Prediction INNER JOIN 
        Messages ON Messages.MessageId = Prediction.MessageId 
    WHERE (Prediction.MessageId=Messages.MessageId);&#39;&#39;&#39;).fetchall()

    return jsonify(all_logs)

@app.route(&#39;/api/v1/resources/predictions/spams&#39;, methods=[&#39;GET&#39;])
def spams():
    &#34;&#34;&#34;function that will return every message that have been flagged as a spam
    the sql query is simple enough, where we join the messages table with the prediction table and filter with only 1 values that are spams

    Returns:
        [json]: query result as a json
    &#34;&#34;&#34;
    conn = sqlite3.connect(&#39;database.db&#39;)
    conn.row_factory = dict_factory
    cur = conn.cursor()
    all_logs = cur.execute(&#39;SELECT Messages.MessageId as Id, Messages.Content as Message, Prediction.Confidence as Confidence,Messages.Date as Date, Messages.Author as AuthorsIp FROM Messages INNER JOIN Prediction ON Prediction.MessageId = Messages.MessageId WHERE Prediction.Prediction = 1;&#39;).fetchall()

    return jsonify(all_logs)


@app.route(&#39;/api/v1/resources/predictions/predict&#39;, methods=[&#39;GET&#39;])
def predict():
    
    &#34;&#34;&#34;bread and butter of the api
    allows you to pass a message and will return the message, the model prediction and it&#39;s confidence on the prediction
    this function will load the model and the vectorizer that should be placed in the &#34;models&#34; folder.
    

    Example : api/v1/resources/predictions/predict?Message=Hello do you want to get free money 
    result : {
  &#34;Confidence&#34;: 0.5584389870347015, 
  &#34;Message&#34;: &#34;Hello do you want to get free money&#34;, 
  &#34;Prediction&#34;: 0.0
    }
    Returns:
        json: json file with the message, prediction and model&#39;s confidence
    &#34;&#34;&#34;

    loaded_model = pickle.load(open(&#34;../models/final_prediction.pickle&#34;, &#39;rb&#39;))
    loaded_vectorizer = pickle.load(open(&#34;../models/final_prediction_vectorizer.pickle&#34;,&#39;rb&#39;))
    
    params = request.args
    message = params.get(&#39;Message&#39;)
    data = [message]
    ip_address = flask.request.remote_addr
    vect = loaded_vectorizer.transform(data).todense() 

    my_prediction = float(loaded_model.predict(vect)[0])
    my_confidence = float(max(loaded_model.predict_proba(vect)[0])) # the max value of the array is the probability of the prediction so that&#39;s what we want to display 
    # my_confidence = float(loaded_model.predict_proba(vect))
    keys = [&#39;Message&#39;,&#39;Prediction&#39;,&#39;Confidence&#39;]
    print(my_confidence)
    values = [message,my_prediction, my_confidence]
    date = str(datetime.now()) 
    results = {}
    for i in range(0,len(keys)):
        results[keys[i]] = values[i] # ugly indirection 
        
    with sqlite3.connect(&#34;database.db&#34;) as con:
        cur = con.cursor()
        # we want to store our messages and the prediction associated with them, we may also need the confidence of the model in case of false positives that are close to the 0.50 threshold
        # we&#39;re also logging the ip of the sender just in case 
        cur.execute(&#34;INSERT INTO Messages (Content,Author,IsSpam,Date) VALUES (?,?,?,?)&#34;,(data[0],ip_address,my_prediction,date) ) 
        lastRow = cur.lastrowid
        cur.execute(&#34;INSERT INTO Prediction (Prediction,Confidence,MessageId) VALUES (?,?,?)&#34;,(my_prediction,my_confidence,lastRow) )
        con.commit()
        print(&#34;Record successfully added&#34;)
        print(results)


    return jsonify(results)

if __name__ == &#39;__main__&#39;:
    app.run(debug=True)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="datascience-ybettayeb.api.app.api_all"><code class="name flex">
<span>def <span class="ident">api_all</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>this function will return the entire prediction database when queried</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>json</code></dt>
<dd>query result as a json</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/api/v1/resources/predictions/all&#39;, methods=[&#39;GET&#39;])
def api_all():
    &#34;&#34;&#34;
    this function will return the entire prediction database when queried

    Returns:
        json: query result as a json
    &#34;&#34;&#34;
    conn = sqlite3.connect(&#39;database.db&#39;)
    conn.row_factory = dict_factory
    cur = conn.cursor()
    all_logs = cur.execute(&#39;&#39;&#39;SELECT * FROM Prediction INNER JOIN 
        Messages ON Messages.MessageId = Prediction.MessageId 
    WHERE (Prediction.MessageId=Messages.MessageId);&#39;&#39;&#39;).fetchall()

    return jsonify(all_logs)</code></pre>
</details>
</dd>
<dt id="datascience-ybettayeb.api.app.dict_factory"><code class="name flex">
<span>def <span class="ident">dict_factory</span></span>(<span>cursor, row)</span>
</code></dt>
<dd>
<div class="desc"><p>wrapper function to turn sqlite rows into dictionnary, to help us jsonify them</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>cursor</code></strong> :&ensp;<code>sqliteCursor</code></dt>
<dd>connection cursor</dd>
<dt><strong><code>row</code></strong> :&ensp;<code>cursor.row</code></dt>
<dd>sqlQuery Row</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>dictionary</code></dt>
<dd>dictionnary containing the result of the query</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def dict_factory(cursor, row): 
    &#34;&#34;&#34;
    wrapper function to turn sqlite rows into dictionnary, to help us jsonify them

    Args:
        cursor (sqliteCursor): connection cursor
        row (cursor.row): sqlQuery Row

    Returns:
        dictionary: dictionnary containing the result of the query
    &#34;&#34;&#34;
    d = {}
    for idx, col in enumerate(cursor.description):
        d[col[0]] = row[idx]
    return d</code></pre>
</details>
</dd>
<dt id="datascience-ybettayeb.api.app.home"><code class="name flex">
<span>def <span class="ident">home</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>basic home page rendering, not much to see there</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/&#39;, methods=[&#39;GET&#39;])
def home():
    &#34;&#34;&#34;
    basic home page rendering, not much to see there
    &#34;&#34;&#34;
    return &#39;&#39;&#39;&lt;h1&gt;Spam Classifier&lt;/h1&gt; &lt;p&gt;prototype API to detect if you&#39;re spamming or hamming &lt;/p&gt;&#39;&#39;&#39;</code></pre>
</details>
</dd>
<dt id="datascience-ybettayeb.api.app.page_not_found"><code class="name flex">
<span>def <span class="ident">page_not_found</span></span>(<span>e)</span>
</code></dt>
<dd>
<div class="desc"><p>handling of 404 error</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.errorhandler(404)
def page_not_found(e):
    &#34;&#34;&#34;
    handling of 404 error
    &#34;&#34;&#34;
    return &#34;&lt;h1&gt;404&lt;/h1&gt;&lt;p&gt;The resource could not be found.&lt;/p&gt;&#34;, 404</code></pre>
</details>
</dd>
<dt id="datascience-ybettayeb.api.app.predict"><code class="name flex">
<span>def <span class="ident">predict</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>bread and butter of the api
allows you to pass a message and will return the message, the model prediction and it's confidence on the prediction
this function will load the model and the vectorizer that should be placed in the "models" folder.</p>
<p>Example : api/v1/resources/predictions/predict?Message=Hello do you want to get free money
result : {
"Confidence": 0.5584389870347015,
"Message": "Hello do you want to get free money",
"Prediction": 0.0
}
Returns:
json: json file with the message, prediction and model's confidence</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/api/v1/resources/predictions/predict&#39;, methods=[&#39;GET&#39;])
def predict():
    
    &#34;&#34;&#34;bread and butter of the api
    allows you to pass a message and will return the message, the model prediction and it&#39;s confidence on the prediction
    this function will load the model and the vectorizer that should be placed in the &#34;models&#34; folder.
    

    Example : api/v1/resources/predictions/predict?Message=Hello do you want to get free money 
    result : {
  &#34;Confidence&#34;: 0.5584389870347015, 
  &#34;Message&#34;: &#34;Hello do you want to get free money&#34;, 
  &#34;Prediction&#34;: 0.0
    }
    Returns:
        json: json file with the message, prediction and model&#39;s confidence
    &#34;&#34;&#34;

    loaded_model = pickle.load(open(&#34;../models/final_prediction.pickle&#34;, &#39;rb&#39;))
    loaded_vectorizer = pickle.load(open(&#34;../models/final_prediction_vectorizer.pickle&#34;,&#39;rb&#39;))
    
    params = request.args
    message = params.get(&#39;Message&#39;)
    data = [message]
    ip_address = flask.request.remote_addr
    vect = loaded_vectorizer.transform(data).todense() 

    my_prediction = float(loaded_model.predict(vect)[0])
    my_confidence = float(max(loaded_model.predict_proba(vect)[0])) # the max value of the array is the probability of the prediction so that&#39;s what we want to display 
    # my_confidence = float(loaded_model.predict_proba(vect))
    keys = [&#39;Message&#39;,&#39;Prediction&#39;,&#39;Confidence&#39;]
    print(my_confidence)
    values = [message,my_prediction, my_confidence]
    date = str(datetime.now()) 
    results = {}
    for i in range(0,len(keys)):
        results[keys[i]] = values[i] # ugly indirection 
        
    with sqlite3.connect(&#34;database.db&#34;) as con:
        cur = con.cursor()
        # we want to store our messages and the prediction associated with them, we may also need the confidence of the model in case of false positives that are close to the 0.50 threshold
        # we&#39;re also logging the ip of the sender just in case 
        cur.execute(&#34;INSERT INTO Messages (Content,Author,IsSpam,Date) VALUES (?,?,?,?)&#34;,(data[0],ip_address,my_prediction,date) ) 
        lastRow = cur.lastrowid
        cur.execute(&#34;INSERT INTO Prediction (Prediction,Confidence,MessageId) VALUES (?,?,?)&#34;,(my_prediction,my_confidence,lastRow) )
        con.commit()
        print(&#34;Record successfully added&#34;)
        print(results)


    return jsonify(results)</code></pre>
</details>
</dd>
<dt id="datascience-ybettayeb.api.app.spams"><code class="name flex">
<span>def <span class="ident">spams</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>function that will return every message that have been flagged as a spam
the sql query is simple enough, where we join the messages table with the prediction table and filter with only 1 values that are spams</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>[json]</code></dt>
<dd>query result as a json</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#39;/api/v1/resources/predictions/spams&#39;, methods=[&#39;GET&#39;])
def spams():
    &#34;&#34;&#34;function that will return every message that have been flagged as a spam
    the sql query is simple enough, where we join the messages table with the prediction table and filter with only 1 values that are spams

    Returns:
        [json]: query result as a json
    &#34;&#34;&#34;
    conn = sqlite3.connect(&#39;database.db&#39;)
    conn.row_factory = dict_factory
    cur = conn.cursor()
    all_logs = cur.execute(&#39;SELECT Messages.MessageId as Id, Messages.Content as Message, Prediction.Confidence as Confidence,Messages.Date as Date, Messages.Author as AuthorsIp FROM Messages INNER JOIN Prediction ON Prediction.MessageId = Messages.MessageId WHERE Prediction.Prediction = 1;&#39;).fetchall()

    return jsonify(all_logs)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="datascience-ybettayeb.api" href="index.html">datascience-ybettayeb.api</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="datascience-ybettayeb.api.app.api_all" href="#datascience-ybettayeb.api.app.api_all">api_all</a></code></li>
<li><code><a title="datascience-ybettayeb.api.app.dict_factory" href="#datascience-ybettayeb.api.app.dict_factory">dict_factory</a></code></li>
<li><code><a title="datascience-ybettayeb.api.app.home" href="#datascience-ybettayeb.api.app.home">home</a></code></li>
<li><code><a title="datascience-ybettayeb.api.app.page_not_found" href="#datascience-ybettayeb.api.app.page_not_found">page_not_found</a></code></li>
<li><code><a title="datascience-ybettayeb.api.app.predict" href="#datascience-ybettayeb.api.app.predict">predict</a></code></li>
<li><code><a title="datascience-ybettayeb.api.app.spams" href="#datascience-ybettayeb.api.app.spams">spams</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>